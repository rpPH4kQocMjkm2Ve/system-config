#!/bin/bash
# /usr/local/bin/atomic-guard
#
# Pacman hook guard: blocks direct system upgrades.
# Allows upgrades only when called from atomic-upgrade (via env + lock)
# or from AUR helpers (yay, paru, etc.) which invoke pacman themselves.

if [[ -r /usr/local/lib/atomic/common.sh ]]; then
    source /usr/local/lib/atomic/common.sh 2>/dev/null || true
fi
LOCK_FILE="${LOCK_FILE:-/var/lock/atomic-upgrade.lock}"

# If called during atomic-upgrade: verify lock is actually held
if [[ "${ATOMIC_UPGRADE:-}" == "1" ]]; then
    [[ -f "$LOCK_FILE" ]] || exit 1
    # If we CAN acquire the lock, nobody holds it — that's wrong
    flock -n "$LOCK_FILE" -c true 2>/dev/null && exit 1
    exit 0
fi

# ── Sysupgrade detection ────────────────────────────────────────
# Only block full system upgrades (-Su / -Syu / --sync --sysupgrade).
# Walk up the process tree to find the pacman process, then inspect
# its cmdline arguments.
is_sysupgrade() {
    local pid=$$
    while [[ $pid -ne 1 ]]; do
        local comm
        comm=$(cat "/proc/$pid/comm" 2>/dev/null) || break
        if [[ "$comm" == "pacman" ]]; then
            local has_sync=0 has_upgrade=0 arg
            while IFS= read -r -d '' arg; do
                [[ "$arg" == "--sync" ]] && has_sync=1
                [[ "$arg" == "--sysupgrade" ]] && has_upgrade=1
                if [[ "$arg" =~ ^-[^-] ]]; then
                    [[ "$arg" == *S* ]] && has_sync=1
                    [[ "$arg" == *u* ]] && has_upgrade=1
                fi
            done < "/proc/$pid/cmdline"
            [[ $has_sync -eq 1 && $has_upgrade -eq 1 ]] && return 0
            return 1
        fi
        pid=$(awk '{print $4}' "/proc/$pid/stat" 2>/dev/null) || break
    done
    # Cannot find pacman in process tree — block for safety
    return 0
}

if ! is_sysupgrade; then
    exit 0
fi

# Allow AUR helpers — walk up the process tree via /proc

if type -t is_child_of_aur_helper &>/dev/null && is_child_of_aur_helper; then
    exit 0
fi

cat << 'EOF'
════════════════════════════════════════════════════════════════
  Direct upgrade blocked. Use: sudo atomic-upgrade
════════════════════════════════════════════════════════════════
EOF
exit 1
