#!/bin/bash
# /usr/local/bin/atomic-guard

if [[ -r /usr/local/lib/atomic/common.sh ]]; then
    source /usr/local/lib/atomic/common.sh 2>/dev/null || true
fi
LOCK_FILE="${LOCK_FILE:-/var/lock/atomic-upgrade.lock}"

if [[ "${ATOMIC_UPGRADE:-}" == "1" ]]; then
    [[ -f "$LOCK_FILE" ]] || exit 1
    flock -n "$LOCK_FILE" -c true 2>/dev/null && exit 1
    exit 0
fi

if pstree -s $$ | grep -qE 'yay|paru'; then
    exit 0
fi

cat << 'EOF'
════════════════════════════════════════════════════════════════
  Direct upgrade blocked. Use: sudo atomic-upgrade
════════════════════════════════════════════════════════════════
EOF
exit 1
