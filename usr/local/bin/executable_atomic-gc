#!/bin/bash
# /usr/local/bin/atomic-gc

[[ $EUID -eq 0 ]] || { echo "ERROR: Must run as root" >&2; exit 1; }

set -euo pipefail

source /usr/local/lib/atomic/common.sh

show_help() {
    cat << EOF
atomic-gc - Manage generations

Usage:
    atomic-gc [OPTIONS] [COUNT]    Garbage collect (keep COUNT, default: $KEEP_GENERATIONS)
    atomic-gc list                 List all generations
    atomic-gc rm GEN_ID [...]      Delete specific generation(s)

Options:
    -n, --dry-run    Show what would be done
    -y, --yes        Skip confirmation (for rm)
    -h, --help       Show this help

EOF
    exit 0
}

case "${1:-}" in
    -h|--help) show_help ;;
esac

validate_config || exit 1

DRY_RUN=0
YES=0
COMMAND="gc"

case "${1:-}" in
    list) COMMAND="list"; shift ;;
    rm)   COMMAND="rm"; shift ;;
esac

ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        -n|--dry-run) DRY_RUN=1; shift ;;
        -y|--yes) YES=1; shift ;;
        -*) echo "ERROR: Unknown option: $1" >&2; exit 1 ;;
        *) ARGS+=("$1"); shift ;;
    esac
done

acquire_lock

cleanup_gc() {
    set +e
    mountpoint -q "$BTRFS_MOUNT" 2>/dev/null && umount "$BTRFS_MOUNT"
    [[ -n "${LOCK_FD:-}" ]] && exec {LOCK_FD}>&-
}
trap cleanup_gc EXIT

case "$COMMAND" in
    list)
        current_subvol=$(get_current_subvol)
        ensure_btrfs_mounted || exit 1
        generations=$(list_generations)
        [[ -z "$generations" ]] && { echo "No generations found"; exit 0; }
        for gen_id in $generations; do
            if [[ "root-${gen_id}" == "$current_subvol" ]]; then
                echo "  * ${gen_id}  (current)"
            else
                echo "    ${gen_id}"
            fi
        done
        ;;
    rm)
        [[ ${#ARGS[@]} -eq 0 ]] && { echo "ERROR: Specify generation(s) to delete" >&2; exit 1; }
        ensure_btrfs_mounted || exit 1
        # Validate all targets exist before deleting any
        for gen_id in "${ARGS[@]}"; do
            if [[ ! -f "${ESP}/EFI/Linux/arch-${gen_id}.efi" ]] && \
               [[ ! -d "${BTRFS_MOUNT}/root-${gen_id}" ]]; then
                echo "ERROR: Generation not found: ${gen_id}" >&2
                exit 1
            fi
        done
        if [[ "$YES" -eq 0 && "$DRY_RUN" -eq 0 ]]; then
            echo "Will delete: ${ARGS[*]}"
            read -rp "Continue? [y/N] " answer
            [[ "$answer" =~ ^[Yy] ]] || { echo "Aborted"; exit 0; }
        fi
        for gen_id in "${ARGS[@]}"; do
            delete_generation "$gen_id" "$DRY_RUN"
        done
        ;;
    gc)
        KEEP_COUNT="${ARGS[0]:-$KEEP_GENERATIONS}"
        if ! [[ "$KEEP_COUNT" =~ ^[0-9]+$ ]] || [[ "$KEEP_COUNT" -lt 1 ]]; then
            echo "ERROR: Invalid count: $KEEP_COUNT" >&2
            exit 1
        fi
        garbage_collect "$KEEP_COUNT" "$DRY_RUN"
        ;;
esac
