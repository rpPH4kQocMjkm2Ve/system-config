#!/bin/bash
# /usr/local/bin/atomic-guard
#
# Pacman hook guard: blocks direct system upgrades (pacman -Syu).
# Allows:
#   - Package installs without --sysupgrade (pacman -S, -R, etc.)
#   - Upgrades via atomic-upgrade (env var + lock verification)
#   - Upgrades via AUR helpers (yay, paru, etc.)

if [[ -r /usr/local/lib/atomic/common.sh ]]; then
    source /usr/local/lib/atomic/common.sh 2>/dev/null || true
fi
LOCK_FILE="${LOCK_FILE:-/var/lock/atomic-upgrade.lock}"

# ── Atomic-upgrade context ───────────────────────────────────────
# If called during atomic-upgrade: verify lock when accessible.
# Inside chroot /run is a fresh tmpfs — lock file won't exist,
# so we trust the env var (only root can set it anyway).
if [[ "${ATOMIC_UPGRADE:-}" == "1" ]]; then
    if [[ -f "$LOCK_FILE" ]]; then
        # Lock file exists — verify it's actually held.
        # If we CAN acquire it, nobody holds it → spoofed env var.
        flock -n "$LOCK_FILE" -c true 2>/dev/null && exit 1
    fi
    exit 0
fi

# ── Sysupgrade detection ────────────────────────────────────────
# Only block full system upgrades (-Su / -Syu / --sync --sysupgrade).
# Walk up the process tree to find the pacman process, then inspect
# its cmdline arguments.
is_sysupgrade() {
    local pid=$$
    while [[ $pid -ne 1 ]]; do
        local comm
        comm=$(cat "/proc/$pid/comm" 2>/dev/null) || break
        if [[ "$comm" == "pacman" ]]; then
            local has_sync=0 has_upgrade=0 arg
            while IFS= read -r -d '' arg; do
                [[ "$arg" == "--sync" ]] && has_sync=1
                [[ "$arg" == "--sysupgrade" ]] && has_upgrade=1
                if [[ "$arg" =~ ^-[^-] ]]; then
                    [[ "$arg" == *S* ]] && has_sync=1
                    [[ "$arg" == *u* ]] && has_upgrade=1
                fi
            done < "/proc/$pid/cmdline"
            [[ $has_sync -eq 1 && $has_upgrade -eq 1 ]] && return 0
            return 1
        fi
        pid=$(awk '{print $4}' "/proc/$pid/stat" 2>/dev/null) || break
    done
    # Cannot find pacman in process tree — block for safety
    return 0
}

if ! is_sysupgrade; then
    exit 0
fi

# ── AUR helper detection ────────────────────────────────────────
is_child_of_aur_helper() {
    local pid=$$
    while [[ $pid -ne 1 ]]; do
        local comm
        comm=$(cat "/proc/$pid/comm" 2>/dev/null) || break
        case "$comm" in
            yay|paru|pikaur|aura) return 0 ;;
        esac
        pid=$(awk '{print $4}' "/proc/$pid/stat" 2>/dev/null) || break
    done
    return 1
}

if is_child_of_aur_helper; then
    exit 0
fi

cat << 'EOF'
════════════════════════════════════════════════════════════════
  Direct upgrade blocked. Use: sudo atomic-upgrade
════════════════════════════════════════════════════════════════
EOF
exit 1
